# 要件定義書: 努力量記録・可視化Webアプリケーション

## 1. プロジェクト概要
ユーザーが日々の様々な活動（勉強、運動、研究など）に費やした「努力量（時間）」を記録し、グラフで可視化するWebアプリケーション。
個人のモチベーション維持と目標達成のサポートを目的とする。将来的なデプロイを見据え、複数人利用（ユーザー認証）を想定したアーキテクチャを採用する。

## 2. 技術スタックとインフラ構成
* **フレームワーク**: Next.js (App Router)
* **フロントエンドUI**: React, Chakra UI（v3）
* **データベース / 認証**: Supabase (PostgreSQL, ユーザー認証)
* **グラフ描画**: Chart.js (+ chartjs-plugin-zoom) または Recharts
* **ホスティング（想定）**: Cloudflare Pages
  ※ バックエンド処理（Route Handlers）はCloudflareのEdgeランタイムで動作させることを前提とし、`@cloudflare/next-on-pages` の利用を想定したエッジ互換の実装を行うこと（`export const runtime = 'edge';` の指定など）。

## 3. コア機能要件

### 3.1 ユーザー・認証機能
* Supabase Authを用いたユーザー登録・ログイン機能。
* 行レベルセキュリティ（RLS）等を設定し、ユーザーごとに自身のデータのみを管理・閲覧できるデータ分離。
* 認証はgoogleアカウントで行う。

### 3.2 カテゴリー管理機能
* ユーザーごとに任意のカテゴリーの追加・編集・論理削除機能。
* カテゴリーごとに任意のテーマカラーを設定可能（グラフ描画時に使用）。
* **削除の仕様**: 論理削除（`is_archived`フラグ等）を採用。削除済みのカテゴリーは新規記録時の選択肢からは非表示となるが、過去の記録一覧やグラフの集計には維持される。

### 3.3 努力の記録（入力）機能
1. **手動記録**: 開始時間と終了時間を入力して記録。
2. **タイマー記録**: 
   * 画面上のボタンで計測を開始／終了し、終了時にカテゴリーを選択して保存。
   * **バックグラウンド保持**: タイマー稼働中にブラウザやタブを閉じても、ローカルストレージやDBの仮テーブルを用いて開始時刻を保持し、再アクセス時に経過時間を正しく復元して表示する。
   * **自動停止（上限設定）**: 計測開始から「10時間」を経過した場合は、自動的に計測を停止し、10時間分の記録として処理・保存する。
   * 自動停止した記録は仮保存状態とし、次回アクセス時に『10時間で自動停止しました。記録を編集・保存してください』というトースト通知と編集モーダルを出す。
   * DBには全てUTCで保存し、フロントエンドおよび集計処理はユーザーのローカルタイムゾーンで行う。

### 3.4 記録の管理機能
* 過去の記録の一覧表示（日付ごと、週ごと、月ごとを選択してまとめて表示できる）、編集、削除（物理削除または論理削除）機能。
* **日付の扱い**: 日付をまたぐ記録（例: 23:00開始〜翌01:00終了）は、「開始日（この場合は前日）」の努力量として集計・記録する。

### 3.5 目標設定・進捗表示機能
* **目標の種類**: デイリー目標（1日の目標時間）、期間目標（特定期日までの目標時間）。
* **カテゴリー指定**: 全体の合計時間に対する目標だけでなく、特定のカテゴリー単体に対する目標も設定可能とする。達成までの残り時間をUI上に表示する。
* **目標を達成したら紙吹雪などで祝う。

### 3.6 グラフ・可視化機能
* **期間指定の積み上げ面グラフ**: 指定期間（例:「2月中」）におけるカテゴリー別の努力量を「積み上げ面グラフ (Stacked Area Chart)」で表示。
* **累積・ズーム対応の積み上げ面グラフ**: 過去から現在までの努力の蓄積（累積値）を積み上げ面グラフで表示し、マウスホイールで期間の拡大・縮小が可能。
* **1日のタイムライン円グラフ**: 日付を指定し、その日の24時間の使い道を、開始・終了時間をもとに「24時間表記の円グラフ（ドーナツチャート等）」でタイムラインとして可視化する。

## 4. バリデーションとエラーハンドリング
フロントエンドおよびバックエンド（API）の両方で以下のチェックとハンドリングを行うこと。
* **時間の論理チェック**: 終了時間が開始時間よりも前になる入力を弾く。
* **未来時間の禁止**: 手動入力において、現在時刻よりも未来の時間を指定できないようにする。
* **重複記録の禁止**: 新規記録の開始時間〜終了時間が、既に存在する別の記録の期間と重複（クロス）することを禁止する（努力Aの終了時間より前に、努力Bが開始される状態を防ぐ）。
* **エラーハンドリング**: Supabaseの通信エラー、認証エラー、バリデーションエラー発生時には、ユーザーに分かりやすいトースト通知（Chakra UIのToast等）を表示してフィードバックする。

## 5. データモデル（Supabase 推奨スキーマ構成案）
以下のテーブル構造をベースにSupabaseのスキーマを設計・実装すること。
* `users`: Auth連携用
* `categories`: id, user_id, name, color, is_archived (boolean, default: false), created_at, updated_at
* `records`: id, user_id, category_id, start_time, end_time, created_at, updated_at
* `goals`: id, user_id, category_id (nullable), type (daily or period), target_hours, deadline, created_at, updated_at

## 6. Claude Codeへの開発指示
上記の要件を満たすWebアプリケーションのプロジェクトをゼロからセットアップしてください。
以下の手順で段階的に進めてください。

1. **プロジェクト初期化**: Next.js (App Router), Chakra UIのセットアップ。Cloudflare Pages (Edge環境) で動かすための設定。
2. **DB構築**: Supabaseのテーブル作成用SQL（RLSポリシー含む）の提示。
3. **コア実装**: 認証機能、タイマー機能（ローカルストレージ等での状態保持と10時間上限ロジック含む）、重複バリデーションロジックの実装。
4. **UI実装**: 手動記録・一覧・各種グラフ（Chart.js / Recharts）のコンポーネント実装。

実装時は、各API Routeにおいて `export const runtime = 'edge';` を設定し、Node.js固有のAPI（fs等）を使用しないよう徹底してください。まずはステップ1と2の設定およびSQLから出力をお願いします。